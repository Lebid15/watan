# Generated maintenance include. Mounted to /etc/nginx/conf.d/maintenance.conf
# Toggle via env var or by editing this file inside the container and nginx -s reload.

## Maintenance mode mapping based on switch variable set in per-server context (mode.conf)
## $maintenance_switch will be set to 'on' or 'off' (default empty -> off)
map $maintenance_switch $maintenance_mode {
	default off;
	on      on;
	off     off;
}

# Exempt paths (use normalized $uri so query strings do not break matches):
# - /dev and /dev/* (frontend dev tooling)
# - /api/webhooks/* (third-party callbacks)
# - /api/health (uptime probes)
# - /api/dev/maintenance-status (status probe)
# - /api/dev/maintenance (frontend overlay polling)
# - /api/dev/toggle-nginx-maint (control)
map $uri $is_maint_exempt {
	# 0 = NOT exempt (will get maintenance when mode ON)
	# 1 = exempt (always allowed)
	default 0;
	# Allow ONLY developer & control endpoints while in maintenance:
	# Frontend developer pages under /dev and backend/overlay APIs under /api/dev/
	~^/dev(?:/|$)              1;
	~^/api/dev/                1;
	# Next.js core static assets needed for /dev to render properly (CSS/JS)
	# NOTE: إتاحة هذه الأصول تعني أن زائر لديه HTML قديم مخزّن قد يرى جزءاً من الواجهة بدون وظائف كاملة.
	~^/_next/static/           1;
	~^/_next/image/            1;
	~^/_next/data/             1;
	# (Removed /login and auth endpoints from exemptions to avoid partial app loading during maintenance)
	# Needed assets during maintenance (favicon) & profile fetch for dev UI
	/favicon.ico               1;
	/api/users/profile-with-currency 1;
	# Always allow the internal maintenance page resource itself to avoid recursion
	/maintenance.html          1;
}

# Optional developer bypass via cookie: set cookie X_MAINT_DEV=allow in browser to skip maintenance globally
map $cookie_X_MAINT_DEV $dev_cookie_bypass {
	default 0;
	~*^allow$ 1;
}

# Optional developer query bypass ?dev=1 or ?dev=allow
map $arg_dev $dev_query_bypass {
	default 0;
	# Accept ?dev=1 or ?dev=allow (case-insensitive). Removed duplicate literal entries that caused
	# "conflicting parameter 'allow'" at nginx start.
	~*^(1|allow)$ 1;
}

# Optional custom header X-Dev-Bypass: allow
map $http_x_dev_bypass $dev_header_bypass {
	default 0;
	~*^allow$ 1;
}

# Combine any bypass source (cookie OR query OR header)
map "$dev_cookie_bypass:$dev_query_bypass:$dev_header_bypass" $dev_any_bypass {
	default 0;
	~^1:.*:.*$ 1;
	~^0:1:.*$ 1;
	~^0:0:1$ 1;
}

# Combine path exemption OR cookie bypass => unified flag
map "$is_maint_exempt:$dev_any_bypass" $is_maint_exempt_final {
	default 0;
	~^1:.*$ 1;   # path exempt
	~^0:1$   1;   # not path exempt but has bypass
}
