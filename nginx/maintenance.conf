# Generated maintenance include. Mounted to /etc/nginx/conf.d/maintenance.conf
# Toggle via env var or by editing this file inside the container and nginx -s reload.

## Maintenance mode mapping based on switch variable set in per-server context (mode.conf)
## $maintenance_switch will be set to 'on' or 'off' (default empty -> off)
map $maintenance_switch $maintenance_mode {
	default off;
	on      on;
	off     off;
}

# Exempt paths (use normalized $uri so query strings do not break matches):
# - /dev and /dev/* (frontend dev tooling)
# - /api/webhooks/* (third-party callbacks)
# - /api/health (uptime probes)
# - /api/dev/maintenance-status (status probe)
# - /api/dev/maintenance (frontend overlay polling)
# - /api/dev/toggle-nginx-maint (control)
map $uri $is_maint_exempt {
	default 0;
	/api/health                       1;
	~^/api/webhooks/                  1;
	~^/api/dev/maintenance-status$    1;
	~^/api/dev/maintenance$           1;
	~^/api/dev/toggle-nginx-maint$    1;
	~^/dev(?:/|$)                     1;
	/login                            1;  # allow login page during maintenance
	/favicon.ico                      1;
	~^/_next/                         1;  # next.js static chunks
	~^/assets/                        1;  # custom static assets
}
