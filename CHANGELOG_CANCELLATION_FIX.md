# Changelog - Order Cancellation Fix

## [1.0.0] - 2025-10-13

### Fixed
- **إلغاء الطلبات التلقائي**: تم إصلاح مشكلة عدم تحديث حالة الطلبات تلقائياً عند إلغائها من المزود الخارجي
  - إضافة دعم كامل للتهجئة الأمريكية `canceled` بجانب البريطانية `cancelled`
  - تحسين فحص الحالات النهائية لضمان عدم إعادة محاولة التحقق من الطلبات الملغاة
  - إضافة سجلات تشخيصية تفصيلية لتتبع معالجة حالات الإلغاء

### Changed
- **`djangoo/apps/orders/tasks.py`**:
  - تحديث `final_statuses` لتشمل `'canceled'`
  - تحديث `order_status_map` لتشمل `'canceled': 'rejected'`
  - تحسين منطق فحص الحالة النهائية في نهاية دالة `check_order_status`
  - إضافة سجلات إضافية لسبب الإلغاء (cancelled by provider / failed)

### Impact
- ✅ الطلبات الملغاة من المزود تُحدّث فوراً إلى حالة `rejected`
- ✅ يتم إعادة الرصيد تلقائياً للمستخدم عند الإلغاء
- ✅ يتوقف النظام عن محاولة التحقق من الطلبات المنتهية
- ✅ تحسين قابلية التشخيص والصيانة

### Files Modified
- `djangoo/apps/orders/tasks.py` (5 تعديلات)

### Documentation
- `CANCELLATION_FIX.md` - توثيق شامل للمشكلة والحل

### Testing
- يُنصح باختبار السيناريوهات التالية:
  1. طلب يُلغى من المزود بحالة `cancelled`
  2. طلب يُلغى من المزود بحالة `canceled`
  3. طلب يفشل من المزود بحالة `failed`
  4. التحقق من إعادة الرصيد بشكل صحيح
  5. التحقق من توقف محاولات التحقق المتكررة

### Migration Required
لا يوجد - التغييرات في منطق التطبيق فقط

### Rollback Plan
إذا ظهرت مشاكل، يمكن التراجع عن التغييرات في `tasks.py` باستخدام:
```bash
git revert <commit_hash>
```

### Related Issues
- المشكلة الأصلية: الطلبات المُلغاة من المزود تظل بحالة `pending`
- التأثير: عدم إعادة الرصيد للمستخدمين
- الأولوية: عالية (Critical)

---
**Reviewed by**: Pending
**Approved by**: Pending
**Deployed to**: Pending
