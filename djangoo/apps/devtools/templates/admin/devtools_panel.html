{% extends "admin/change_list.html" %}
{% block content %}
  <div class="card">
    <div class="card-header"><h2>التنبيهات</h2></div>
    <div class="card-body">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
      {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      <!-- Section 1: Alerts (banner) -->
      <h3 class="mt-2 mb-2">شريط التنبيه أعلى الهيدر</h3>
      <form method="post" action="{% url 'admin:devtools-apply' %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="id_tenantId">Tenant ID (اختياري):</label>
          {{ form.tenantId }}
        </div>
        <div class="form-group">
          <label for="id_text">نص التنبيه (أعلى الهيدر):</label>
          {{ form.text }}
        </div>
        <div class="form-group">
          <label for="id_enabled">تفعيل التنبيه:</label>
          {{ form.enabled }}
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">حفظ التنبيه</button>
        </div>
      </form>

      {% if global_banner_text or global_banner_enabled %}
      <hr class="my-4">
      <div class="alert alert-info">
        <div class="mb-2"><strong>آخر رسالة محفوظة:</strong></div>
        <div class="border rounded p-2 bg-light" style="white-space:pre-wrap;">{{ global_banner_text|default:"—" }}</div>
        <div class="text-muted mt-2">الحالة: {{ global_banner_enabled|yesno:"مفعّل,متوقف" }}</div>
        {% if global_banner_updated_at %}
        <div class="text-muted mt-1">آخر تحديث: {{ global_banner_updated_at }}</div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Section 2: Maintenance mode -->
      <hr class="my-4">
      <h3 class="mt-2 mb-2">وضع الصيانة</h3>
      <form method="post" action="{% url 'admin:devtools-maintenance' %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="id_message">رسالة الصيانة:</label>
          {{ maint_form.message }}
        </div>
        <div class="form-group">
          <label for="id_enabled">تفعيل وضع الصيانة:</label>
          {{ maint_form.enabled }}
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-warning">تحديث وضع الصيانة</button>
        </div>
        {% if maint_message %}
          <div class="text-muted mt-2">الحالة الحالية: {{ maint_enabled|yesno:"مفعّل,متوقف" }}</div>
          <div class="border rounded p-2 bg-light mt-2" style="white-space:pre-wrap;">{{ maint_message }}</div>
        {% endif %}
      </form>

      <!-- Section 3: Two-factor auth enforcement -->
      <hr class="my-4">
      <h3 class="mt-2 mb-2">تفعيل المصادقة الثنائية</h3>
      <p class="text-muted">هذا الخيار يفرض على جميع المستخدمين (ما عدا المطور) تفعيل TOTP عند تسجيل الدخول.</p>
      <form method="post" action="{% url 'admin:devtools-force2fa' %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="id_force_all">فرض تفعيل المصادقة الثنائية:</label>
          {{ force2fa_form.force_all }}
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-secondary">تحديث الإعداد</button>
        </div>
      </form>

    </div>
  </div>
{% endblock %}
