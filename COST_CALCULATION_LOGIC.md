# ๐ฐ ููุทู ุญุณุงุจ ุงูุชูููุฉ (Cost Calculation Logic)

## ๐ ููุฎุต

ุชู ุชุตููุญ ููุทู ุญุณุงุจ ุชูููุฉ ุงูุทูุจุงุช ููุชูุงุณุจ ูุน **ุซูุงุซ ุญุงูุงุช** ูุฎุชููุฉ ุญุณุจ ููุน ุชูููุฐ ุงูุทูุจ.

---

## ๐ฏ ุงูุญุงูุงุช ุงูุซูุงุซุฉ

### โ ุงูุญุงูุฉ 1: ูุฒูุฏ ุฎุงุฑุฌู (External Provider)

**ุงูุดุฑุท:**
```python
if order.provider_id and order.external_order_id:
```

**ุงูููุทู:**
1. ุงูุทูุจ ุชู ุฅุฑุณุงูู ููุฒูุฏ ุฎุงุฑุฌู (ูุซู znet, barakat, apstore)
2. **ุงูุฃููููุฉ ุงูุฃููู**: ุงูุจุญุซ ูู ุฌุฏูู `package_costs` ุนู ุงูุชูููุฉ ุงููุญุฏุฏุฉ ููุฐุง ุงููุฒูุฏ
3. **Fallback**: ุฅุฐุง ูู ููุฌุฏ `PackageCost`ุ ุงุณุชุฎุฏู `package.base_price`

**ูุซุงู:**
- ุทูุจ PUBG ุชู ุฅุฑุณุงูู ูู znet
- ูุจุญุซ ุนู `PackageCost` ุญูุซ:
  - `tenant_id` = tenant ุงูุญุงูู
  - `package_id` = ุจุงูุฉ PUBG
  - `provider_id` = znet
- ุฅุฐุง ูุฌุฏูุง ุงูุณุฌูุ ูุฃุฎุฐ `cost_amount` (ูุซูุงู $0.85)
- ูุฐู ูู **ุงูุชูููุฉ ุงููุนููุฉ** ุงูุชู ุณุชุฏูุนูุง ูููุฒูุฏ

**ุงูููุฏ:**
```python
package_cost = PackageCost.objects.get(
    tenant_id=tenant_id,
    package_id=order.package_id,
    provider_id=order.provider_id
)
base_usd = package_cost.cost_amount
```

---

### โ ุงูุญุงูุฉ 2: ุชูููุฐ ุฏุงุฎูู (Internal/Manual Execution)

**ุงูุดุฑุท:**
```python
elif order.status == 'approved' and not order.provider_id:
```

**ุงูููุทู:**
1. ุงูุทูุจ ุชู ุชูููุฐู ุฏุงุฎููุงู (manual execution)
2. ูู ูุชู ุฅุฑุณุงูู ูุฃู ูุฒูุฏ ุฎุงุฑุฌู
3. **ุงูุชูููุฉ = $0** (ูุฃูู ุชููุฐู ุจููุณู)

**ูุซุงู:**
- ุงููุณุชุฃุฌุฑ ูููุฐ ุงูุทูุจ ูุฏููุงู (manual)
- ูุง ููุฌุฏ `provider_id`
- ุงูุชูููุฉ = $0
- ูู ุงููุจูุบ = ุฑุจุญ ุตุงูู

**ุงูููุฏ:**
```python
base_usd = Decimal('0')  # ุงูุชูููุฉ = 0 ููุชูููุฐ ุงูุฏุงุฎูู
```

---

### โ ุงูุญุงูุฉ 3: pending ุฃู ูู ูุฌููุนุฉ ุงูุฃุณุนุงุฑ (Price Group)

**ุงูุดุฑุท:**
```python
else:  # ุงูุทูุจ pending ุฃู ูู ููุฑุณู ุจุนุฏ
```

**ุงูููุทู:**
1. ุงูุทูุจ ูู ูุชู ุชูููุฐู ุจุนุฏ (status = pending)
2. ุฃู ุงูุทูุจ ูู ุญุงูุฉ ุงูุชุธุงุฑ
3. ูุฃุฎุฐ ุงูุชูููุฉ **ุงูุชูุฏูุฑูุฉ** ูู `package.base_price`
4. ูุฐู ุงููููุฉ ูู `price_group` ุงููุฑุชุจุท ุจุงููุณุชุฎุฏู

**ูุซุงู:**
- ุทูุจ ุฌุฏูุฏ ุชู ุฅูุดุงุคู
- ูู ูุชู ุฅุฑุณุงูู ูููุฒูุฏ ุจุนุฏ
- ูุนุฑุถ ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ ูู `package.base_price`
- ุนูุฏ ุงูุฅุฑุณุงู ูููุฒูุฏุ ุณุชุชุญุฏุซ ุงูุชูููุฉ ูููููุฉ ุงููุนููุฉ (ุงูุญุงูุฉ 1)

**ุงูููุฏ:**
```python
pkg = ProductPackage.objects.get(id=order.package_id)
base_usd = Decimal(str(pkg.base_price or pkg.capital or 0))
```

---

## ๐ ูุซุงู ุนููู

### ุณููุงุฑูู: ุทูุจ PUBG 60 UC

#### ๐ ุงููุนูููุงุช:
- ุงูุจุงูุฉ: PUBG 60 UC
- `package.base_price` = $0.90 (ูู price_group)
- `PackageCost` ูู znet = $0.85 (ุงูุชูููุฉ ุงููุนููุฉ)
- ุณุนุฑ ุงูุจูุน: $1.20

#### ๐ ูุฑุงุญู ุงูุทูุจ:

**1๏ธโฃ ุนูุฏ ุงูุฅูุดุงุก (pending):**
```
Status: pending
Provider: null
Cost: $0.90 (ูู base_price)
Profit: $1.20 - $0.90 = $0.30
```

**2๏ธโฃ ุจุนุฏ ุงูุฅุฑุณุงู ูู znet:**
```
Status: pending โ processing
Provider: znet
External Order ID: 123456
Cost: $0.85 (ูู PackageCost)
Profit: $1.20 - $0.85 = $0.35 โ
```

**3๏ธโฃ ูู ูุงู ุงูุชูููุฐ ูุฏูู:**
```
Status: approved
Provider: null (manual)
External Order ID: null
Cost: $0.00 (ุชูููุฐ ุฏุงุฎูู)
Profit: $1.20 - $0.00 = $1.20 ๐ฐ
```

---

## ๐ ุฌุฏูู ุงูููุงุฑูุฉ

| ุงูุญุงูุฉ | ุงูุดุฑุท | ูุตุฏุฑ ุงูุชูููุฉ | ุงููููุฉ | ููุงุญุธุงุช |
|--------|-------|--------------|--------|----------|
| **ูุฒูุฏ ุฎุงุฑุฌู** | `provider_id && external_order_id` | `PackageCost.cost_amount` | $0.85 | ุชูููุฉ ูุนููุฉ |
| **ุชูููุฐ ุฏุงุฎูู** | `status=approved && !provider_id` | ุซุงุจุชุฉ | $0.00 | ูุง ุชูุฌุฏ ุชูููุฉ |
| **pending/ููุฏ ุงูุงูุชุธุงุฑ** | `else` | `package.base_price` | $0.90 | ุชูููุฉ ุชูุฏูุฑูุฉ |

---

## ๐๏ธ ุงููููุงุช ุงููุนุฏููุฉ

### 1. `djangoo/apps/orders/services.py`
- **ุงูุฏุงูุฉ**: `freeze_fx_on_approval()`
- **ุงูุชุบููุฑ**: ุฅุถุงูุฉ ููุทู if-elif-else ูุชุญุฏูุฏ ูุตุฏุฑ ุงูุชูููุฉ
- **ุงูุณุทุฑ**: ~390-445

---

## โ ุงูููุงุฆุฏ

1. โ **ุฏูุฉ ุฃุนูู**: ุงูุชูููุฉ ุงููุนููุฉ ูู ุงููุฒูุฏ ุงูุฎุงุฑุฌู
2. โ **ุดูุงููุฉ**: ุงูุชูููุฉ = $0 ููุชูููุฐ ุงูุฏุงุฎูู
3. โ **ุชูุฏูุฑ ุตุญูุญ**: ููุทูุจุงุช pending ูู price_group
4. โ **ุฃุฑุจุงุญ ุตุญูุญุฉ**: ุงูุฑุจุญ ููุญุณุจ ุจูุงุกู ุนูู ุงูุชูููุฉ ุงููุนููุฉ

---

## ๐ฏ ูุง ุงูุชุงููุ

### ุงุฎุชุจุงุฑ ุงููุธุงู:
1. โ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ (pending) - ุดูู ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ
2. โ ุฅุฑุณุงู ุงูุทูุจ ููุฒูุฏ ุฎุงุฑุฌู - ุดูู ุงูุชูููุฉ ุงููุนููุฉ
3. โ ุชูููุฐ ุทูุจ ูุฏููุงู - ุดูู ุงูุชูููุฉ = $0
4. โ ุชุญูู ูู ุงูุฃุฑุจุงุญ ูู ูู ุญุงูุฉ

### ููุงุญุธุงุช ูููุณุชูุจู:
- ๐ ุชุฃูุฏ ูู ูุฌูุฏ `PackageCost` ููู ุจุงูุฉ ูุน ูู ูุฒูุฏ
- ๐ ุฑุงูุจ ุงูุญุงูุงุช ุงูุชู ุชุณุชุฎุฏู fallback (base_price)
- ๐ ูููู ุฅุถุงูุฉ ุชูุจูู ุฅุฐุง PackageCost ุบูุฑ ููุฌูุฏ

---

โ **ุชู ุงูุชุทุจูู ุจูุฌุงุญ!** ๐
