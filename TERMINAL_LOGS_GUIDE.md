# دليل سجلات فحص الطلبات (Terminal Logs Guide)

## 📋 نظرة عامة
تم إضافة سجلات واضحة ومفصلة في الـ terminal لتتبع عملية فحص حالة الطلبات من المزودين الخارجيين.

## 🎯 كيفية رؤية السجلات

### 1️⃣ تشغيل Celery Worker
```bash
cd djangoo
celery -A djangoo worker --loglevel=info
```

### 2️⃣ تشغيل Celery Beat (للمهام الدورية)
```bash
cd djangoo
celery -A djangoo beat --loglevel=info
```

### 3️⃣ تشغيل كليهما معاً
```bash
cd djangoo
celery -A djangoo worker --beat --loglevel=info
```

## 📊 أنواع السجلات

### 🔍 بداية فحص الطلب
```
====================================================================================================
🔍 [محاولة #1] فحص حالة الطلب: 12345678...
====================================================================================================
```

### ✅ طلب في حالة نهائية
```
✅ الطلب في حالة نهائية: completed
   الحالة الداخلية: approved
====================================================================================================
```

### 📡 استعلام من المزود
```
📡 استعلام عن حالة الطلب من المزود: barakat
   المرجع: 12345
   الحالة الحالية: pending
```

### 📥 استجابة المزود
```
📥 استجابة المزود:
   الحالة: completed
   PIN Code: 1234567890...
   الرسالة: Order completed successfully
```

### 🔄 معالجة الحالة
```
🔄 معالجة الحالة:
   📌 الحالة من المزود: completed
   📌 الحالة المطبّعة: done
   📌 الحالة الداخلية الجديدة: approved
   📊 الحالة الحالية: pending
   ✨ تغيير في الحالة: pending → completed
```

### ⚙️ تطبيق انتقال الحالة
```
⚙️ تطبيق انتقال الحالة:
   من: pending → إلى: approved
   سيتم تحديث الرصيد...
   ✅ نجح تحديث الحالة والرصيد
   الحالة النهائية: approved
```

### 🔄 تحديث الحالة الخارجية فقط
```
🔄 تحديث الحالة الخارجية فقط: pending → processing
```

### 🔑 استلام PIN Code
```
🔑 استلام PIN Code: 1234567890...
```

### 💬 تحديث الرسالة
```
💬 تحديث الرسالة: Order is being processed...
```

### 💾 تحديث قاعدة البيانات
```
💾 تم تحديث قاعدة البيانات بنجاح (1 صف)
```

### ⏳ طلب لا يزال معلقاً
```
⏳ الطلب لا يزال قيد المعالجة
   الحالة الحالية: pending → processing
   سيتم إعادة الفحص بعد 10 ثواني...
====================================================================================================
```

### ✅ اكتمال الفحص
```
✅ اكتمل فحص الطلب - الحالة النهائية: completed
====================================================================================================
```

### ❌ خطأ في الفحص
```
❌ خطأ في فحص الطلب: Connection timeout
====================================================================================================
```

### 🔍 فحص دفعة الطلبات (Batch)
```
####################################################################################################
🔍 بدء فحص دفعة الطلبات المعلقة...
   الوقت: 2025-10-13 22:30:00
####################################################################################################

📊 تم العثور على 3 طلب معلق للفحص
   سيتم جدولة فحص كل طلب بفاصل 0.05 ثانية

الطلبات المعلقة:
   1. 12345678... | pending | انتظار: 5 دقيقة
   2. 23456789... | processing | انتظار: 12 دقيقة
   3. 34567890... | sent | انتظار: 3 دقيقة

✅ تم جدولة فحص 3 طلب
####################################################################################################
```

## 🎨 رموز الحالات

| الرمز | المعنى |
|------|--------|
| 🔍 | فحص / استعلام |
| ✅ | نجاح |
| ❌ | خطأ |
| ⏳ | انتظار / معلق |
| 📡 | اتصال بالمزود |
| 📥 | استجابة من المزود |
| 🔄 | معالجة / تحديث |
| ⚙️ | تطبيق تغيير |
| 💾 | حفظ في قاعدة البيانات |
| 🔑 | PIN Code |
| 💬 | رسالة |
| 📊 | إحصائيات |
| ⏸️ | لا تغيير |
| ✨ | تغيير |
| ⚠️ | تحذير |

## 📝 أمثلة على سيناريوهات كاملة

### سيناريو 1: طلب ناجح (Completed)
```
====================================================================================================
🔍 [محاولة #1] فحص حالة الطلب: 12345678...
====================================================================================================

📡 استعلام عن حالة الطلب من المزود: barakat
   المرجع: 12345
   الحالة الحالية: pending

📥 استجابة المزود:
   الحالة: completed
   PIN Code: ABCD123456...
   الرسالة: تم إنجاز الطلب بنجاح

🔄 معالجة الحالة:
   📌 الحالة من المزود: completed
   📌 الحالة المطبّعة: done
   📌 الحالة الداخلية الجديدة: approved
   📊 الحالة الحالية: pending
   ✨ تغيير في الحالة: pending → completed

⚙️ تطبيق انتقال الحالة:
   من: pending → إلى: approved
   سيتم تحديث الرصيد...
   ✅ نجح تحديث الحالة والرصيد
   الحالة النهائية: approved

🔑 استلام PIN Code: ABCD123456...
💾 تم تحديث قاعدة البيانات بنجاح (1 صف)

✅ اكتمل فحص الطلب - الحالة النهائية: completed
====================================================================================================
```

### سيناريو 2: طلب ملغى من المزود
```
====================================================================================================
🔍 [محاولة #2] فحص حالة الطلب: 87654321...
====================================================================================================

📡 استعلام عن حالة الطلب من المزود: znet
   المرجع: 98765
   الحالة الحالية: processing

📥 استجابة المزود:
   الحالة: cancelled
   الرسالة: تم إلغاء الطلب - رصيد غير كافٍ

🔄 معالجة الحالة:
   📌 الحالة من المزود: cancelled
   📌 الحالة المطبّعة: failed
   📌 الحالة الداخلية الجديدة: rejected
   📊 الحالة الحالية: pending
   ✨ تغيير في الحالة: processing → cancelled

⚙️ تطبيق انتقال الحالة (تم الإلغاء من المزود):
   من: pending → إلى: rejected
   سيتم تحديث الرصيد...
   ✅ نجح تحديث الحالة والرصيد
   الحالة النهائية: rejected

💬 تحديث الرسالة: تم إلغاء الطلب - رصيد غير كافٍ
💾 تم تحديث قاعدة البيانات بنجاح (1 صف)

✅ اكتمل فحص الطلب - الحالة النهائية: cancelled
====================================================================================================
```

### سيناريو 3: طلب لا يزال معلقاً
```
====================================================================================================
🔍 [محاولة #1] فحص حالة الطلب: 45678901...
====================================================================================================

📡 استعلام عن حالة الطلب من المزود: ahla400
   المرجع: 55555
   الحالة الحالية: sent

📥 استجابة المزود:
   الحالة: processing

🔄 معالجة الحالة:
   📌 الحالة من المزود: processing
   📌 الحالة المطبّعة: processing
   📌 الحالة الداخلية الجديدة: pending
   📊 الحالة الحالية: pending
   ⏸️  لا تغيير في الحالة

🔄 تحديث الحالة الخارجية فقط: sent → processing
💾 تم تحديث قاعدة البيانات بنجاح (1 صف)

⏳ الطلب لا يزال قيد المعالجة
   الحالة الحالية: processing → processing
   سيتم إعادة الفحص بعد 10 ثواني...
====================================================================================================

... (بعد 10 ثواني)

====================================================================================================
🔍 [محاولة #2] فحص حالة الطلب: 45678901...
====================================================================================================
...
```

## 🔧 التخصيص

### تغيير مستوى التفاصيل
يمكنك تعديل السجلات في `djangoo/apps/orders/tasks.py`:
- سجلات `print()` تظهر في الـ terminal مباشرة
- سجلات `logger` تُسجل في ملف Django logs

### تعطيل السجلات المفصلة
لتعطيل السجلات العربية المفصلة، احذف أسطر `print()` واترك فقط `logger`.

## 📍 الملفات المعدلة
- `djangoo/apps/orders/tasks.py` - إضافة سجلات terminal مفصلة

## 🎯 الفوائد
1. ✅ رؤية واضحة لحالة الطلبات في الوقت الفعلي
2. ✅ تتبع تقدم الفحص لكل طلب
3. ✅ معرفة متى يتم إعادة الفحص (كل 10 ثواني)
4. ✅ رؤية التغييرات في الحالات بوضوح
5. ✅ تشخيص المشاكل بسهولة
6. ✅ مراقبة عملية تحديث الرصيد

---
**التاريخ**: 13 أكتوبر 2025  
**الحالة**: ✅ جاهز للاستخدام
