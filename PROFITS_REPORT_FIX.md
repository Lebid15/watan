# إصلاح تقرير الأرباح - Profits Report Fix

## المشكلة (Problem)

كانت صفحة تقرير الأرباح `/admin/reports/profits` تعرض بيانات غير متطابقة:

### السبب الرئيسي:
- **العدادات (counts)** كانت تستخدم `createdAt` (تاريخ إنشاء الطلب)
- **الإجماليات (totals)** كانت تستخدم `approvedLocalDate` (تاريخ الموافقة على الطلب)

### مثال على المشكلة:
```
الطلب #1:
- تاريخ الإنشاء (createdAt): 2025-10-10
- تاريخ الموافقة (approvedLocalDate): 2025-10-09
- القيمة: 1 USD

عند فلترة "اليوم" (2025-10-10):
✅ العدادات: تحسب الطلب (لأنه أُنشئ اليوم)
❌ الإجماليات: لا تحسب الطلب (لأنه اعتُمد بالأمس)

النتيجة:
- إجمالي الطلبات: 1
- المقبولة: 1
- مجموع سعر البيع: 0.00 USD ❌
- الربح: 0.00 USD ❌
```

## الحل (Solution)

### تم توحيد معيار التاريخ:

1. **للطلبات المقبولة (approved)**: تستخدم `approvedLocalDate`
   - هذا هو التاريخ الصحيح لحساب الأرباح
   - القيم المجمّدة (`sellTryAtApproval`, `costTryAtApproval`) تُحفظ عند الموافقة

2. **للطلبات المرفوضة (rejected)**: تستخدم `createdAt`
   - الطلبات المرفوضة ليس لها تاريخ موافقة
   - تُحسب فقط في العدادات وليس في الإجماليات

3. **العدادات الآن متطابقة مع الإجماليات**:
   ```
   العدادات = المقبولة (حسب approvedLocalDate) + المرفوضة (حسب createdAt)
   الإجماليات = فقط المقبولة (حسب approvedLocalDate)
   ```

## الملفات المعدّلة (Modified Files)

### Django Backend (الحالي - المستخدم فعلياً)
- `djangoo/apps/reports/views.py`
  - تم تعديل class `AdminReportsProfitsView`
  - تم فصل استعلامات الطلبات حسب الحالة:
    - **approved**: يستخدم `approved_local_date` (تاريخ الموافقة)
    - **rejected**: يستخدم `created_at__date` (تاريخ الإنشاء)
  - تم استخدام القيم المجمّدة عند الموافقة:
    - `sell_try_at_approval` (سعر البيع بالليرة)
    - `cost_try_at_approval` (التكلفة بالليرة)
    - `fx_usd_try_at_approval` (سعر الصرف المجمّد)
  - تم تحسين `AdminReportsProvidersView`:
    - جلب المزودين من جدول `integrations` بدلاً من `ProductOrder`
    - إضافة خيار "يدوي" للطلبات اليدوية
    - عرض اسم المزود الفعلي بدلاً من ID فقط
  - تم إصلاح فلترة المزودين:
    - دعم فلترة "manual" (طلبات بدون مزود)
    - دعم فلترة حسب ID المزود المحدد
  - تم إصلاح `AdminReportsUsersView`:
    - ✅ فلترة المستخدمين حسب `tenant_id` (كان يعرض جميع المستخدمين!)
    - ترتيب المستخدمين حسب الأحدث
    - عرض اسم المستخدم فقط (بدلاً من username - email)

### Frontend
- `frontend/src/app/admin/reports/profits/page.tsx`
  - تم حذف عرض سعر الصرف من واجهة المستخدم
  - تم تنظيف المتغيرات غير المستخدمة

### NestJS Backend (قديم - للمرجع فقط)
- `backend/src/admin/reports.admin.controller.ts`
  - تم تعديل endpoint `getProfits()`
  - نفس المنطق المُطبق في Django

## التحقق من الإصلاح (Verification)

### قبل الإصلاح:
```
إجمالي الطلبات: 1
المقبولة: 1
المرفوضة: 0
مجموع التكلفة (USD): 2.00 USD
مجموع سعر البيع (USD): 100.00 USD
الربح النهائي (USD): 98.00 USD
```

### بعد الإصلاح (متوقع):
```
إجمالي الطلبات: 1
المقبولة: 1
المرفوضة: 0
مجموع التكلفة (USD): 1.00 USD  ← القيمة الصحيحة من الباقة
مجموع سعر البيع (USD): 1.00 USD  ← القيمة الصحيحة من الباقة
الربح النهائي (USD): 0.00 USD  ← الربح الصحيح
```

## ملاحظات إضافية (Additional Notes)

### لماذا نستخدم `approvedLocalDate`؟
1. **الدقة المحاسبية**: الربح الفعلي يُحسب عند الموافقة، ليس عند الإنشاء
2. **القيم المجمّدة**: جميع القيم المالية (`sellTryAtApproval`, `costTryAtApproval`) تُحفظ عند الموافقة
3. **سعر الصرف**: سعر الصرف يُجمّد عند الموافقة (`fxUsdTryAtApproval`)
4. **الفترات المحاسبية**: التقارير المالية تعتمد على تاريخ الموافقة

### السلوك الجديد:
- الطلبات المُنشأة اليوم لكن لم تُعتمد بعد → لن تظهر في التقرير
- الطلبات المُعتمدة اليوم (حتى لو أُنشئت بالأمس) → تظهر في التقرير
- الطلبات المرفوضة → تُحسب في العدادات فقط

## كيفية الاختبار (Testing)

1. افتح صفحة تقرير الأرباح: `http://alsham.localhost:3000/admin/reports/profits/`
2. اختر الفترة "اليوم"
3. تحقق من:
   - تطابق عدد الطلبات المقبولة مع القيم المالية
   - صحة قيم التكلفة وسعر البيع والربح
   - تطابق القيم مع الباقات الفعلية للطلبات

## التاريخ
- **تاريخ الإصلاح**: 2025-10-10
- **المطور**: GitHub Copilot
- **السبب**: عدم تطابق البيانات بين العدادات والإجماليات في تقرير الأرباح

## التحديثات الإضافية (Additional Updates)

### 1. إصلاح فلتر المزودين
- **المشكلة**: كان يجلب المزودين من `ProductOrder.provider_id` فقط (المزودين المستخدمين في الطلبات)
- **الحل**: الآن يجلب من جدول `integrations` (جميع المزودين المفعّلين)
- **الفائدة**: عرض جميع المزودين المتاحة حتى لو لم تُستخدم بعد

### 2. دعم الطلبات اليدوية
- إضافة خيار "يدوي" في قائمة المزودين
- فلترة صحيحة للطلبات اليدوية (`provider_id = null` أو `''`)

### 3. إصلاح فلتر المستخدمين (مهم جداً!) ⚠️
- **المشكلة الخطيرة**: كان يعرض **جميع المستخدمين من جميع المستأجرين**!
- **الحل**: الآن يُفلتر حسب `tenant_id` فقط
- **الأمان**: منع تسرب بيانات المستخدمين بين المستأجرين
- **التحسين**: ترتيب المستخدمين حسب الأحدث

### 4. تحسين واجهة المستخدم
- حذف عبارة سعر الصرف غير الضرورية
- تنظيف الكود من المتغيرات غير المستخدمة

---

## ⚠️ ملاحظة مهمة
النظام حالياً يعمل على **Django Backend** (`djangoo/`)، وليس NestJS Backend (`backend/`).  
التعديلات الأساسية تمت على الملف: `djangoo/apps/reports/views.py`

تم تعديل `backend/src/admin/reports.admin.controller.ts` للمرجعية فقط في حال الحاجة لاحقاً.
